# 修复 Windows 终端中文乱码 CHINESE Encoding UTF-8

## 问题说明

在 Windows PowerShell 或 CMD 中运行 Java 应用时，中文字符可能显示为乱码，这是因为：
1. Windows 终端默认使用 GBK 编码（代码页 936）
2. Java 应用默认使用系统编码，但标准输出/错误输出可能没有使用 UTF-8

## 解决方案

本项目已经实现了三层修复：

### 1. 代码层面修复 ✅
在 `AiTestProjectApplication.java` 启动类中已添加：
- 设置标准输出和错误输出使用 UTF-8
- 设置 JVM 默认字符集为 UTF-8

### 2. 构建配置修复 ✅
在 `pom.xml` 中已添加：
- Maven Spring Boot 插件 JVM 参数：`-Dfile.encoding=UTF-8`

### 3. 终端编码修复 ✅

#### 方法 A：使用提供的启动脚本（推荐）

**批处理脚本（CMD）：**
```cmd
start-app.bat
```

**PowerShell 脚本：**
```powershell
.\start-app.ps1
```

#### 方法 B：手动设置终端编码

**PowerShell（每次启动前）：**
```powershell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::InputEncoding = [System.Text.Encoding]::UTF8
chcp 65001
```

**CMD（每次启动前）：**
```cmd
chcp 65001
```

#### 方法 C：永久设置 PowerShell 编码

在 PowerShell 配置文件中添加以下内容：

1. 查看配置文件路径：
```powershell
$PROFILE
```

2. 如果文件不存在，创建它：
```powershell
New-Item -Path $PROFILE -Type File -Force
```

3. 添加以下内容到配置文件：
```powershell
# 设置 UTF-8 编码
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::InputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001 | Out-Null
```

4. 重新加载配置：
```powershell
. $PROFILE
```

### 4. 使用 Maven 命令启动

如果直接使用 Maven 命令，请添加编码参数：

```cmd
mvnw spring-boot:run -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8
```

或：

```powershell
.\mvnw.cmd spring-boot:run -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8
```

## 验证修复

启动应用后，查看控制台输出，中文字符应该正常显示，例如：
- ✅ `OllamaService 初始化完成 - 使用 RAG 增强`
- ✅ `WebSocket 连接已建立，会话ID: xxx`
- ✅ `收到消息 [会话 xxx]: 你好`

如果仍然显示乱码，请检查：
1. 是否使用了正确的启动脚本
2. IDE 终端编码设置（IDEA/VS Code 等）
3. Windows 系统区域设置

## 常见问题

### Q: 为什么需要三层修复？
A: 
- 代码层面：确保 Java 应用内部使用 UTF-8
- 构建配置：确保 Maven 传递正确的 JVM 参数
- 终端层面：确保 PowerShell/CMD 能正确显示 UTF-8 字符

### Q: 使用 IDE 运行应用还需要设置吗？
A: 大多数 IDE（如 IntelliJ IDEA）的终端默认支持 UTF-8，但如果在 IDE 中仍然乱码：
- **IntelliJ IDEA**: File → Settings → Editor → File Encodings → 确保都是 UTF-8
- **VS Code**: 终端编码通常自动处理，如有问题检查 `files.encoding` 设置

### Q: 只修复代码层面可以吗？
A: 不可以。Windows 终端默认编码是 GBK，即使 Java 输出 UTF-8，终端也无法正确显示。必须同时设置终端编码。

## 测试

运行以下命令测试编码是否正常：

```powershell
# 设置编码
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001

# 测试中文输出
Write-Host "测试中文：你好世界"
echo "测试中文：你好世界"
```

如果这两行命令输出的中文正常，说明终端编码已正确设置。




